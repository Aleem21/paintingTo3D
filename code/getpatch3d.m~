function DE=getpatch3d(P,DE,x,d,X)
% X is the image of 3dPoints corresponding to the points in the image

[w h]=size(X);

X0=squeeze(X(x(1),x(2),:));
[K R t]=decomposeP(P);
D=R(3,:)*(X0-t);

dXx=R'*[1 0 0]'.*D./K(1,1);
dXy=R'*[0 1 0]'.*D./K(2,2);

DE.3d_bbox=zeros(1,4);
DE.3d_bbox(1)=X0-d1.*dXx-d2.*dXy;
DE.3d_bbox(2)=X0-d1.*dXx+d2.*dXy;
DE.3d_bbox(3)=X0+d1.*dXx-d2.*dXy;
DE.3d_bbox(4)=X0+d1.*dXx+d2.*dXy;

% patch3d.isValid=D>5;
% patch2d.isValid=D>5;

 patch3d.U=(X0-t)./sqrt(sum((X0-t).*(X0-t)));
patch3d.z=R(3,:);
patch3d.D=D;
patch3d.origin=t;
patch3d.center=X0;
patch3d.P=P;

end